<div id="map-wrapper">
    <div id='map'></div>

    <script>
        // MapBox API Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZXBhdTg4IiwiYSI6ImNqdjhyemQwNDAzM3U0MnJ5bW9ndHI4bXoifQ.JjTAqjq-WeON4_zK7naPEw';

        // Creates a new map and style, with starting location in Vancouver
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v11', // stylesheet location
            center: [-123.116226, 49.246292], // starting position [lng, lat]
            zoom: 11 // starting zoom
        });

        // Declares long and lat variables to be used
        let long = undefined
        let lat = undefined 

        // Function that retrieves current location using HTML5 from the browser
        const defaultPosition = () => {
            navigator.geolocation.getCurrentPosition((position) => {
                lat = position.coords.latitude
                long = position.coords.longitude
                map.flyTo({
                    center: [long, lat],
                    zoom: 13
                });

            // Create a HTML element for current location
            var el = document.createElement('div');
            el.className = 'currentmarker';

            // Make a marker for the current location and add to map
            new mapboxgl.Marker(el)
                .setLngLat([long, lat])
                .addTo(map);
            })
        }

        // Fires the default location function which moves the map to the current location.
        defaultPosition();

        map.on('load', function () {
            // Add a layer showing the places.
            map.addLayer({
                "id": "places",
                "type": "symbol",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": geojson
                    }
                },
                "layout": {
                    "icon-image": "{icon}-15",
                    "icon-allow-overlap": true
                }
            });

            // When a click event occurs on a feature in the places layer, open a popup at the
            // location of the feature, with description HTML from its properties.
            map.on('click', 'places', function (e) {
                let coordinates = e.features[0].geometry.coordinates.slice();
                let description = e.features[0].properties.description;

                // Ensure that if the map is zoomed out such that multiple
                // copies of the feature are visible, the popup appears
                // over the copy being pointed to.
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }
                map.flyTo({
                    center: [coordinates[0], coordinates[1]],
                    zoom: 15
                });

                // Builds the popup when user clicks on a host marker.
                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML('<img class="host-marker-img" src="https://image.flaticon.com/icons/svg/1579/1579928.svg" alt="host"> <span class="host-marker-title">'
                             + description + '</span>')
                    .addTo(map);
            });

            // Change the cursor to a pointer when the mouse is over the places layer.
            map.on('mouseenter', 'places', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', 'places', function () {
                map.getCanvas().style.cursor = '';
            });
        });

        // Populates the map using geojson object
        var geojson = [
        {
            "type": "Feature",
            "properties": {
                "description": "UBC Charger",
                "icon": "marker"
            },
            "geometry": {
            "type": "Point",
            "coordinates": [-123.259563, 49.269246]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "description": "Edwin's Charger",
                "icon": "marker"
            },
            "geometry": {
            "type": "Point",
            "coordinates": [-123.134504, 49.175458]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "description": "BCIT Downtown Charger",
                "icon": "marker"
            },
            "geometry": {
            "type": "Point",
            "coordinates": [-123.115272, 49.283332]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "description": "BCIT Burnaby Charger",
                "icon": "marker"
            },
            "geometry": {
            "type": "Point",
            "coordinates": [-123.002025, 49.250124]
            }
        },
        ]

        // Uses a for loop to add markers to the map page
        geojson.forEach( (marker) => {

            // Create a HTML element for each feature
            var el = document.createElement('div');
            el.className = 'marker';

            // make a marker for each feature and add to the map
            new mapboxgl.Marker(el)
                .setLngLat(marker.geometry.coordinates)
                .addTo(map);
        });
    </script>
</div>